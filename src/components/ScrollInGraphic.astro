<!-- ---
const {
  src = "/graphics/sticker.svg",
  startOffsetPct = -150,
  maxDistance = 300,
} = Astro.props;
---

<scroll-in-graphic
  data-start-offset={startOffsetPct}
  data-max-distance={maxDistance}
  class="block"
>
  <div
    class="relative flex items-center justify-center overflow-visible"
    style={`transform: translateX(${startOffsetPct}%); will-change: transform;`}
  >
    <img src={src} alt="scroll graphic" class="max-w-full h-auto" />
  </div>
</scroll-in-graphic>

<script>
  class ScrollInGraphic extends HTMLElement {
    constructor() {
      super();
      this.handleScroll = this.handleScroll.bind(this);
      /** @type {HTMLElement | null} */
      let movable = null;
      let startOffset = -150;
      let maxDistance = 300;
    }

    connectedCallback() {
      let startOffset = parseFloat(this.dataset.startOffset || "-150");
      let maxDistance = parseFloat(this.dataset.maxDistance || "300");

      // cast to HTMLElement so TS stops complaining
      let movable = /** @type {HTMLElement | null} */ (this.firstElementChild);

      // run once
      this.handleScroll();

      window.addEventListener("scroll", this.handleScroll, { passive: true });
      window.addEventListener("resize", this.handleScroll);
    }

    disconnectedCallback() {
      window.removeEventListener("scroll", this.handleScroll);
      window.removeEventListener("resize", this.handleScroll);
    }

    handleScroll() {
      if (!this.movable) return;

      const rect = this.getBoundingClientRect();
      const viewportHeight = window.innerHeight;
      const viewportCenter = viewportHeight / 2;
      const elementCenter = rect.top + rect.height / 2;
      const distance = Math.abs(elementCenter - viewportCenter);

      let p = 1 - distance / this.maxDistance;
      if (p < 0) p = 0;
      if (p > 1) p = 1;

      const translateX = (1 - p) * this.startOffset;
      let movable.style.transform = `translateX(${translateX}%)`;
    }
  }

  if (!customElements.get("scroll-in-graphic")) {
    customElements.define("scroll-in-graphic", ScrollInGraphic);
  }
</script> -->
